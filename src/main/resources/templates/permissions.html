<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <title>Permissions</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <style>
        /* Simple modern switch */
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; inset: 0; background: #ddd; transition: .2s; border-radius: 28px; }
        .slider:before { position: absolute; content: ""; height: 22px; width: 22px; left: 3px; bottom: 3px; background: white; transition: .2s; border-radius: 50%; }
        input:checked + .slider { background: #0d6efd; }
        input:checked + .slider:before { transform: translateX(22px); }
        .feature-key { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    </style>
</head>
<body class="container py-4">
<h3 class="mb-4">Permissions</h3>

<div class="table-responsive">
    <table class="table align-middle">
        <thead>
        <tr>
            <th>Feature</th>
            <th class="text-center">Manager</th>
            <th class="text-center">Staff</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="f : ${features}">
            <td class="feature-key" th:text="${f}"></td>
            <!-- Manager toggle -->
            <td class="text-center">
                <label class="switch">
                    <input type="checkbox"
                           th:attr="data-role='MANAGER',data-feature=${f}"
                           th:checked="${manager[f]}">
                    <span class="slider"></span>
                </label>
            </td>
            <!-- Staff toggle -->
            <td class="text-center">
                <label class="switch">
                    <input type="checkbox"
                           th:attr="data-role='STAFF',data-feature=${f}"
                           th:checked="${staff[f]}">
                    <span class="slider"></span>
                </label>
            </td>
        </tr>
        </tbody>
    </table>
</div>

<script>
    document.addEventListener('change', (e) => {
        const el = e.target;
        if (el.matches('input[type="checkbox"][data-role][data-feature]')) {
            const role = el.getAttribute('data-role');
            const feature = el.getAttribute('data-feature');
            const visible = el.checked;

            fetch('/admin/permissions/toggle', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: new URLSearchParams({ role, feature, visible })
            }).catch(() => { el.checked = !visible; alert('Failed to update'); });
        }
    });
</script>
</body>
</html>
